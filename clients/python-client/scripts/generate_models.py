#!/usr/bin/env python3
"""
Generate Pydantic models from KubeRay CRD OpenAPI schemas.

This script extracts the OpenAPI schema from CRD YAML files and generates
typed Pydantic models using datamodel-code-generator.

Usage:
    python scripts/generate_models.py

Requirements:
    pip install pyyaml datamodel-code-generator
"""

import json
import subprocess
import sys
from pathlib import Path

# Paths relative to this script
SCRIPT_DIR = Path(__file__).parent
REPO_ROOT = SCRIPT_DIR.parent.parent.parent
CRD_PATH = REPO_ROOT / "ray-operator" / "config" / "crd" / "bases" / "ray.io_rayjobs.yaml"
OUTPUT_PATH = SCRIPT_DIR.parent / "python_client" / "models" / "generated_rayjob_models.py"


def extract_schema(crd_path: Path) -> dict:
    """Extract OpenAPI schema from CRD YAML."""
    try:
        import yaml
    except ImportError:
        print("ERROR: pyyaml is required. Install with: pip install pyyaml")
        sys.exit(1)

    with open(crd_path) as f:
        crd = yaml.safe_load(f)

    return crd["spec"]["versions"][0]["schema"]["openAPIV3Schema"]


def generate_models(schema: dict, output_path: Path, crd_path: Path) -> None:
    """Generate Pydantic models from schema using datamodel-codegen."""
    
    # Check datamodel-codegen is installed
    try:
        subprocess.run(
            ["datamodel-codegen", "--version"],
            capture_output=True,
            check=True,
        )
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("ERROR: datamodel-code-generator is required.")
        print("Install with: pip install datamodel-code-generator")
        sys.exit(1)

    # Generate to temp file first
    result = subprocess.run(
        [
            "datamodel-codegen",
            "--input-file-type", "jsonschema",
            "--output", str(output_path),
            "--output-model-type", "pydantic_v2.BaseModel",
            "--use-standard-collections",
            "--use-union-operator",
            "--field-constraints",
            "--reuse-model",
            "--collapse-reuse-models",
            "--class-name", "RayJob",
        ],
        input=json.dumps(schema),
        capture_output=True,
        text=True,
    )

    if result.returncode != 0:
        print(f"ERROR: datamodel-codegen failed:\n{result.stderr}")
        sys.exit(1)

    # Read generated content and add proper header
    with open(output_path) as f:
        content = f.read()

    # Remove the default header (first 3 lines)
    lines = content.split("\n")
    if lines[0].startswith("# generated by datamodel-codegen"):
        lines = lines[3:]  # Skip the 3 header lines
        content = "\n".join(lines)

    # Create proper header (no timestamp to avoid CI churn)
    crd_relative = crd_path.relative_to(REPO_ROOT)
    
    header = f'''"""
Auto-generated Pydantic models from KubeRay CRD OpenAPI schema.

DO NOT EDIT THIS FILE MANUALLY!

Generated by: clients/python-client/scripts/generate_models.py
Source CRD:   {crd_relative}

To regenerate (from repo root):
    python clients/python-client/scripts/generate_models.py
"""

'''

    # Write with new header
    with open(output_path, "w") as f:
        f.write(header + content)

    print(f"Generated {output_path}")
    print(f"  Source: {crd_path}")


def main():
    if not CRD_PATH.exists():
        print(f"ERROR: CRD file not found: {CRD_PATH}")
        print("Make sure you're running from the correct directory.")
        sys.exit(1)

    print(f"Extracting schema from {CRD_PATH}...")
    schema = extract_schema(CRD_PATH)

    print(f"Generating Pydantic models...")
    generate_models(schema, OUTPUT_PATH, CRD_PATH)

    print("Done!")


if __name__ == "__main__":
    main()
