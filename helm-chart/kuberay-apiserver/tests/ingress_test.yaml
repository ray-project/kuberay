suite: Test Ingress

templates:
  - ingress.yaml

release:
  name: kuberay-apiserver
  namespace: kuberay-system

tests:
  - it: Should not create Ingress if `ingress.enabled` is `false`
    set:
      ingress:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: Should create Ingress if `ingress.enabled` is `true`
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        enabled: true
    asserts:
      - containsDocument:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          name: kuberay-apiserver
          namespace: kuberay-system

  - it: Should create Ingress if `ingress.enabled` is `true`
    capabilities:
      majorVersion: 1
      minorVersion: 14
    set:
      ingress:
        enabled: true
    asserts:
      - containsDocument:
          apiVersion: networking.k8s.io/v1beta1
          kind: Ingress
          name: kuberay-apiserver
          namespace: kuberay-system

  - it: Should create Ingress if `ingress.enabled` is `true`
    capabilities:
      majorVersion: 1
      minorVersion: 12
    set:
      ingress:
        enabled: true
    asserts:
      - containsDocument:
          apiVersion: extensions/v1beta1
          kind: Ingress
          name: kuberay-apiserver
          namespace: kuberay-system

  - it: Should have ingress backend service name matching the service name
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      ingress:
        enabled: true
        hosts:
          - host: example.com
            paths:
              - path: /
                pathType: Prefix
      service:
        port: 8888
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: kuberay-apiserver

  - it: Should have ingress backend service name matching the service name when fullnameOverride is set
    capabilities:
      majorVersion: 1
      minorVersion: 19
    set:
      fullnameOverride: test-name
      ingress:
        enabled: true
        hosts:
          - host: example.com
            paths:
              - path: /
                pathType: Prefix
      service:
        port: 8888
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.name
          value: test-name
